---
title: "TCGA Breast Cancer Survival Analysis"
subtitle: "Genomic Alterations and Patient Outcomes in Breast Cancer"
author: "Joshua Moses"
output: 
  html_document:
    theme: flatly
    toc: true
    toc_float: false
    toc_depth: 2
    code_folding: hide
    number_sections: true
    df_print: paged
    fig_width: 12
    fig_height: 9
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 12, fig.height = 9)
```

# Overview

This analysis examines survival outcomes in breast cancer patients from The Cancer Genome Atlas (TCGA), stratified by mutation status in key cancer-associated genes (TP53, BRCA1/2). We use Kaplan-Meier curves and Cox proportional hazards regression to assess whether specific genomic alterations are associated with differential survival outcomes.

**Study Design:** Retrospective cohort analysis of simulated TCGA-BRCA data with characteristics matching published literature. The dataset includes clinical outcomes and genomic mutation data for over 1,000 breast cancer patients.

**Research Questions:**

1. Are TP53 mutations associated with differential survival in breast cancer?
2. Do BRCA1/2 mutations predict survival outcomes?
3. What is the independent prognostic value of these mutations after adjusting for age?

---

# Methods

## Setup and Package Installation

```{r packages}
# Load required libraries for survival analysis
library(tidyverse)    # Data manipulation and visualization
library(survival)     # Survival analysis functions
library(survminer)    # Enhanced survival plots
library(ggplot2)      # Additional plotting capabilities
```

The analysis uses standard R packages for survival analysis: `survival` for statistical modeling and `survminer` for creating publication-quality Kaplan-Meier curves.

---

## Data Generation

```{r data-import}
cat("Generating TCGA-style breast cancer dataset...\n")

# Create data directory
if (!dir.exists("data")) {
  dir.create("data")
}

# Generate realistic TCGA-BRCA clinical data
# Based on published TCGA statistics
set.seed(42)  # For reproducibility

n_patients <- 1050

clinical_raw <- tibble(
  PATIENT_ID = paste0("TCGA-", str_pad(1:n_patients, 4, pad = "0")),
  OS_STATUS = sample(c("0:LIVING", "1:DECEASED"), n_patients, 
                     replace = TRUE, prob = c(0.73, 0.27)),  # ~27% mortality
  OS_MONTHS = pmax(1, rnorm(n_patients, mean = 85, sd = 55)),
  AGE = pmax(20, pmin(90, rnorm(n_patients, mean = 58, sd = 13)))
)

# Generate mutation data
# TP53: mutated in ~36% of breast cancers (published rate)
# BRCA1/2: mutated in ~6% of breast cancers
n_tp53 <- round(n_patients * 0.36)
n_brca <- round(n_patients * 0.06)

tp53_patients <- sample(clinical_raw$PATIENT_ID, n_tp53)
brca_patients <- sample(clinical_raw$PATIENT_ID, n_brca)

mutation_raw <- bind_rows(
  tibble(
    Hugo_Symbol = "TP53",
    Tumor_Sample_Barcode = tp53_patients
  ),
  tibble(
    Hugo_Symbol = sample(c("BRCA1", "BRCA2"), n_brca, replace = TRUE),
    Tumor_Sample_Barcode = brca_patients
  )
)

# Make survival outcomes realistic:
# TP53 mutations associated with worse prognosis (HR ~1.4-1.6 in literature)
clinical_raw <- clinical_raw %>%
  mutate(
    has_tp53 = PATIENT_ID %in% tp53_patients,
    has_brca = PATIENT_ID %in% brca_patients,
    # TP53 mutated: reduced survival time
    OS_MONTHS = case_when(
      has_tp53 ~ OS_MONTHS * 0.75,  # 25% reduction in survival time
      has_brca ~ OS_MONTHS * 1.15,  # BRCA mutations often have better outcomes
      TRUE ~ OS_MONTHS
    ),
    # Adjust death status based on survival time
    OS_STATUS = case_when(
      has_tp53 & OS_MONTHS < 60 & runif(n()) < 0.4 ~ "1:DECEASED",
      OS_MONTHS < 30 & runif(n()) < 0.5 ~ "1:DECEASED",
      TRUE ~ OS_STATUS
    )
  ) %>%
  select(-has_tp53, -has_brca)

# Save data
write_tsv(clinical_raw, "data/clinical_raw.txt")
write_tsv(mutation_raw, "data/mutation_raw.txt")

cat("✓ Dataset generated successfully!\n")
cat("  Clinical data:", nrow(clinical_raw), "patients\n")
cat("  Mutation data:", nrow(mutation_raw), "mutations\n")
cat("  TP53 mutations:", n_tp53, "patients\n")
cat("  BRCA1/2 mutations:", n_brca, "patients\n")
cat("\nNote: This is simulated data with characteristics matching published TCGA-BRCA statistics.\n")
```

**Data Source:** This analysis uses simulated data with characteristics matching published TCGA Breast Cancer (TCGA-BRCA) cohort statistics. The simulation incorporates:

- **TP53 mutation frequency:** ~36% (published range: 30-40%)
- **BRCA1/2 mutation frequency:** ~6% (published range: 5-7%)
- **Overall mortality rate:** ~27% 
- **Median follow-up:** ~85 months
- **Age distribution:** Mean 58 years (SD 13 years)

The simulated dataset maintains realistic biological relationships between genomic alterations and clinical outcomes based on published hazard ratios from the literature.

---

## Data Cleaning and Preparation

```{r data-cleaning}
# Clean clinical data - focus on survival variables
clinical_clean <- clinical_raw %>%
  select(PATIENT_ID, OS_STATUS, OS_MONTHS, AGE) %>%
  rename(
    patient_id = PATIENT_ID,
    status = OS_STATUS,
    survival_months = OS_MONTHS,
    age = AGE
  ) %>%
  mutate(
    # Create binary event indicator (1 = death, 0 = censored)
    event = ifelse(status == "1:DECEASED", 1, 0),
    # Ensure numeric types
    survival_months = as.numeric(survival_months),
    age = as.numeric(age)
  ) %>%
  filter(!is.na(survival_months), survival_months > 0)

cat("✓ Cleaned clinical data:", nrow(clinical_clean), "patients\n")
cat("  Deaths observed:", sum(clinical_clean$event), 
    "(", round(100*sum(clinical_clean$event)/nrow(clinical_clean), 1), "%)\n")
cat("  Median survival:", round(median(clinical_clean$survival_months), 1), "months\n")
```

**Data Preprocessing:** The raw clinical data was cleaned to focus on key survival variables: patient ID, vital status, survival time, and age at diagnosis. Patients with missing or invalid survival times were excluded. The final analytical dataset includes `r nrow(clinical_clean)` patients with complete data.

The event indicator was coded as a binary variable (1 = death, 0 = censored), which is the standard format for survival analysis in R's `survival` package.

---

## Mutation Status Assignment

```{r extract-mutations}
# Extract TP53 mutation status
tp53_patients <- mutation_raw %>%
  filter(Hugo_Symbol == "TP53") %>%
  pull(Tumor_Sample_Barcode) %>%
  unique()

# Extract BRCA1/2 mutation status
brca_patients <- mutation_raw %>%
  filter(Hugo_Symbol %in% c("BRCA1", "BRCA2")) %>%
  pull(Tumor_Sample_Barcode) %>%
  unique()

# Add mutation status to clinical data
clinical_clean <- clinical_clean %>%
  mutate(
    tp53_mutated = patient_id %in% tp53_patients,
    tp53_status = ifelse(tp53_mutated, "TP53 Mutated", "TP53 Wild-type"),
    brca_mutated = patient_id %in% brca_patients,
    brca_status = ifelse(brca_mutated, "BRCA1/2 Mutated", "BRCA1/2 Wild-type")
  )

# Summary statistics
cat("\nMutation Summary:\n")
cat("TP53 mutated:", sum(clinical_clean$tp53_mutated), 
    "(", round(100*sum(clinical_clean$tp53_mutated)/nrow(clinical_clean), 1), "%)\n")
cat("BRCA1/2 mutated:", sum(clinical_clean$brca_mutated), 
    "(", round(100*sum(clinical_clean$brca_mutated)/nrow(clinical_clean), 1), "%)\n")
```

**Mutation Annotation:** Each patient's genomic profile was annotated for the presence or absence of mutations in TP53 and BRCA1/2 genes. 

- **TP53** is a tumor suppressor gene frequently mutated in breast cancer, typically associated with more aggressive disease and poorer prognosis
- **BRCA1/2** are DNA repair genes; germline or somatic mutations in these genes are associated with hereditary breast cancer and often show better response to certain therapies

Patients were stratified into mutant vs. wild-type groups for subsequent survival analyses.

---

# Results

## TP53 Mutation Analysis

### Cox Proportional Hazards Model

```{r tp53-analysis}
# Create survival object
surv_object <- Surv(time = clinical_clean$survival_months, 
                    event = clinical_clean$event)

# Kaplan-Meier survival fit for TP53
fit_tp53 <- survfit(surv_object ~ tp53_status, data = clinical_clean)

# Cox proportional hazards model (adjusted for age)
cox_tp53 <- coxph(surv_object ~ tp53_mutated + age, 
                  data = clinical_clean)

# Print Cox model summary
summary(cox_tp53)
```

**Cox Regression Results:** The Cox proportional hazards model assesses the independent effect of TP53 mutation status on survival while adjusting for age. 

- **Hazard Ratio (HR):** The coefficient for `tp53_mutatedTRUE` represents the log hazard ratio. An HR > 1 indicates increased risk of mortality, while HR < 1 indicates reduced risk.
- **Age adjustment:** Controlling for age is critical as it's a known prognostic factor in breast cancer
- **P-value:** Tests the null hypothesis that TP53 mutation status has no effect on survival
- **Concordance:** Measures the model's predictive accuracy (range: 0.5-1.0, where >0.7 is considered good)

### Kaplan-Meier Survival Curves

```{r tp53-plot}
ggsurvplot(
  fit_tp53,
  data = clinical_clean,
  pval = TRUE,
  conf.int = TRUE,
  risk.table = TRUE,
  risk.table.height = 0.25,
  ggtheme = theme_minimal(),
  palette = c("#E7B800", "#2E9FDF"),
  title = "Survival Analysis: TP53 Mutation Status in Breast Cancer",
  xlab = "Time (Months)",
  ylab = "Survival Probability",
  legend.title = "TP53 Status",
  legend.labs = c("TP53 Mutated", "TP53 Wild-type"),
  font.main = c(14, "bold"),
  font.x = c(12),
  font.y = c(12)
)
```

**Figure Interpretation:** 

- **Survival curves:** Each line represents the estimated survival probability over time for patients with (yellow) vs. without (blue) TP53 mutations
- **Shaded areas:** 95% confidence intervals around survival estimates
- **P-value (Log-rank test):** Tests whether survival distributions differ significantly between groups
- **Risk table:** Shows the number of patients at risk at different time points; declining numbers reflect events (deaths) and censoring
- **Curve separation:** Visual divergence between curves suggests differential survival outcomes

If the curves separate early and remain separated, this indicates a consistent survival difference. Crossing curves would suggest time-dependent effects.

---

## BRCA1/2 Mutation Analysis

### Cox Proportional Hazards Model

```{r brca-analysis}
# Kaplan-Meier survival fit for BRCA1/2
fit_brca <- survfit(surv_object ~ brca_status, data = clinical_clean)

# Cox proportional hazards model (adjusted for age)
cox_brca <- coxph(surv_object ~ brca_mutated + age, 
                  data = clinical_clean)

# Print Cox model summary
summary(cox_brca)
```

**Cox Regression Results for BRCA1/2:** This model evaluates whether BRCA1/2 mutations independently predict survival after adjusting for age. BRCA1/2 mutations are particularly relevant in breast cancer due to their role in DNA damage repair and their association with specific therapeutic vulnerabilities (e.g., PARP inhibitor sensitivity).

Key metrics to examine:
- **Hazard ratio magnitude:** Quantifies the strength of association
- **Statistical significance:** P-value < 0.05 indicates a significant effect
- **Confidence intervals:** Wide intervals suggest greater uncertainty in the estimate

### Kaplan-Meier Survival Curves

```{r brca-plot}
ggsurvplot(
  fit_brca,
  data = clinical_clean,
  pval = TRUE,
  conf.int = TRUE,
  risk.table = TRUE,
  risk.table.height = 0.25,
  ggtheme = theme_minimal(),
  palette = c("#FC4E07", "#00AFBB"),
  title = "Survival Analysis: BRCA1/2 Mutation Status in Breast Cancer",
  xlab = "Time (Months)",
  ylab = "Survival Probability",
  legend.title = "BRCA Status",
  legend.labs = c("BRCA1/2 Mutated", "BRCA1/2 Wild-type"),
  font.main = c(14, "bold"),
  font.x = c(12),
  font.y = c(12)
)
```

**Figure Interpretation:** The Kaplan-Meier curves compare survival between BRCA1/2-mutated (red) and wild-type (cyan) patients. 

BRCA1/2 mutations in breast cancer often show complex prognostic effects:
- **Germline carriers** may present with more aggressive tumors but can respond better to platinum-based chemotherapy and PARP inhibitors
- **Somatic mutations** may have different prognostic implications
- The survival difference (or lack thereof) should be interpreted in the context of treatment received

The log-rank p-value tests overall survival differences, while the confidence intervals indicate precision of estimates.

---

## Summary Statistics

```{r summary-table}
# Create summary table
summary_stats <- clinical_clean %>%
  group_by(tp53_status) %>%
  summarise(
    N = n(),
    Deaths = sum(event),
    `Death Rate (%)` = round(100 * sum(event) / n(), 1),
    `Median Survival (months)` = round(median(survival_months[event == 1]), 1),
    `Mean Age` = round(mean(age, na.rm = TRUE), 1)
  )

knitr::kable(summary_stats, caption = "Summary Statistics by TP53 Mutation Status")

# Save table
if (!dir.exists("results")) {
  dir.create("results")
}
write_csv(summary_stats, "results/summary_statistics.csv")
```

**Table Summary:** This table provides descriptive statistics stratified by TP53 mutation status, allowing comparison of baseline characteristics and outcomes between groups.

- **N:** Sample size in each group
- **Deaths:** Number of mortality events observed (remainder are censored observations)
- **Death Rate:** Crude mortality percentage (not adjusted for follow-up time)
- **Median Survival:** Time point at which 50% of patients who died had experienced the event
- **Mean Age:** Average age at diagnosis; important to verify groups are comparable

Differences in death rates and median survival provide initial evidence of prognostic impact, which is then formally tested using survival analysis methods.

---

# Conclusions

```{r key-findings, echo=FALSE}
# Calculate all statistics for inline reporting
total_patients <- nrow(clinical_clean)
total_deaths <- sum(clinical_clean$event)
death_rate <- round(100 * total_deaths / total_patients, 1)
median_followup <- round(median(clinical_clean$survival_months), 1)

tp53_prevalence <- round(100 * sum(clinical_clean$tp53_mutated) / total_patients, 1)
tp53_hr <- round(exp(coef(cox_tp53)["tp53_mutatedTRUE"]), 2)
tp53_pval <- summary(cox_tp53)$coefficients["tp53_mutatedTRUE", "Pr(>|z|)"]
tp53_pval_formatted <- ifelse(tp53_pval < 0.001, "< 0.001", round(tp53_pval, 3))

brca_prevalence <- round(100 * sum(clinical_clean$brca_mutated) / total_patients, 1)
brca_hr <- round(exp(coef(cox_brca)["brca_mutatedTRUE"]), 2)
brca_pval <- summary(cox_brca)$coefficients["brca_mutatedTRUE", "Pr(>|z|)"]
brca_pval_formatted <- ifelse(brca_pval < 0.001, "< 0.001", round(brca_pval, 3))

tp53_sig <- ifelse(tp53_pval < 0.05, "statistically significant", "not statistically significant")
tp53_direction <- ifelse(tp53_hr > 1, "increased", "decreased")
brca_sig <- ifelse(brca_pval < 0.05, "statistically significant", "not statistically significant")
brca_direction <- ifelse(brca_hr > 1, "increased", "decreased")
```

## Key Findings

### Sample Characteristics

- **Total patients analyzed:** `r total_patients`
- **Deaths observed:** `r total_deaths` (`r death_rate`%)
- **Median follow-up:** `r median_followup` months

### TP53 Mutation Analysis

- **Prevalence:** `r tp53_prevalence`% of patients (`r sum(clinical_clean$tp53_mutated)` patients)
- **Hazard Ratio:** `r tp53_hr` (age-adjusted)
- **P-value:** `r tp53_pval_formatted`
- **Interpretation:** TP53 mutations are associated with `r tp53_direction` risk of mortality (HR = `r tp53_hr`), which is **`r tp53_sig`** (p `r ifelse(tp53_pval < 0.05, "<", "=")` `r tp53_pval_formatted`).

### BRCA1/2 Mutation Analysis

- **Prevalence:** `r brca_prevalence`% of patients (`r sum(clinical_clean$brca_mutated)` patients)
- **Hazard Ratio:** `r brca_hr` (age-adjusted)
- **P-value:** `r brca_pval_formatted`
- **Interpretation:** BRCA1/2 mutations are associated with `r brca_direction` risk of mortality (HR = `r brca_hr`), which is **`r brca_sig`** (p `r ifelse(brca_pval < 0.05, "<", "=")` `r brca_pval_formatted`).

---

## Clinical Implications

This survival analysis of `r total_patients` breast cancer patients demonstrates the prognostic value of genomic profiling for TP53 and BRCA1/2 mutations:

1. **TP53 mutations** (`r tp53_prevalence`% prevalence) were `r tp53_sig` associated with survival outcomes after adjusting for age (HR = `r tp53_hr`, p = `r tp53_pval_formatted`). This aligns with published literature showing TP53 as a key driver of aggressive breast cancer phenotypes.

2. **BRCA1/2 mutations** (`r brca_prevalence`% prevalence) showed `r brca_direction` mortality risk (HR = `r brca_hr`, p = `r brca_pval_formatted`), consistent with their complex role in DNA repair and therapeutic response.

**Future Directions:**

- Multivariate models incorporating tumor subtype, stage, and treatment data
- Interaction analyses between mutation status and therapeutic interventions
- Integration of additional genomic alterations (e.g., PIK3CA, HER2 amplification)
- External validation using independent TCGA or institutional cohorts

---

## Methods Summary

**Statistical Approach:**

- **Kaplan-Meier curves:** Non-parametric survival estimates with log-rank tests for group comparisons
- **Cox proportional hazards regression:** Semi-parametric models adjusting for age
- **Significance level:** α = 0.05 (two-tailed)

**Software:** 

- R version `r R.version.string`
- `survival` package (v`r packageVersion("survival")`) for survival analysis
- `survminer` package (v`r packageVersion("survminer")`) for visualization

**Data Note:** This analysis uses simulated data with characteristics matching published TCGA-BRCA cohort statistics to demonstrate survival analysis methodology while maintaining realistic biological relationships between genomic alterations and clinical outcomes.

---

## Session Information

```{r session-info}
sessionInfo()
```